{"componentChunkName":"component---src-templates-blog-post-js","path":"/2018-04-25---deploying-rails-5-2-applications-with-encrypted-credentials-using-capistrano/","result":{"data":{"site":{"siteMetadata":{"title":"waiyan.yoon"}},"markdownRemark":{"id":"5484272c-9c11-53ee-a053-0fd3664f2e60","excerpt":"Context Rails 5.2 has been released with dozens of new features, which highlights the release of ActiveStorage and a new way to deal with encrypted credentials…","html":"<h2>Context</h2>\n<p>Rails 5.2 has been released with dozens of new features, which highlights the release of ActiveStorage and a new way to deal with encrypted credentials within the codebase. This post highlights how encrypted credentials has changed the way secret keys are managed in Rails applications and how it affects the deployment process.</p>\n<p>Let’s see what’s the key difference of the credentials management between Rails 5.2 and previous versions:</p>\n<h3>Before Rails 5.2</h3>\n<ul>\n<li><code class=\"language-text\">secret_key_base</code> was located in <code class=\"language-text\">config/secrets.yml</code></li>\n<li>Every credentials have to be configured in environment variables to keep the credentials secure.</li>\n<li>The environment variables are all being called in <code class=\"language-text\">config/secrets.yml</code></li>\n</ul>\n<h3>Changes Introduced Since Rails 5.2</h3>\n<ul>\n<li>The credentials are <strong>encrypted in local</strong> with the use of <code class=\"language-text\">config/master.key</code>. <code class=\"language-text\">config/master.key</code> will be ignored in git by default.</li>\n<li>The encrypted credentials commited to repo is the encrypted version of credentials: <code class=\"language-text\">config/credentials.yml.enc</code></li>\n<li>We use the command <code class=\"language-text\">$ rails credentials:edit</code>(or <code class=\"language-text\">$ EDITOR=vim rails credentials:edit</code> if <code class=\"language-text\">EDITOR</code> is not configured) to edit the credentils.</li>\n</ul>\n<h2>Deployment Issue Related to Encrypted Credentials</h2>\n<p>Problem comes in when <code class=\"language-text\">config/master.key</code> is not commited in the repo. When <code class=\"language-text\">config/master.key</code> is not found in the production server, the Rails app in the server couldn’t decrypt the credentials thus the credentials couldn’t be used.</p>\n<p>We failed to deploy to production due to this error:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ArgumentError: Missing <span class=\"token variable\"><span class=\"token variable\">`</span>secret_key_base<span class=\"token variable\">`</span></span> <span class=\"token keyword\">for</span> <span class=\"token string\">'production'</span> environment, <span class=\"token builtin class-name\">set</span> this string with <span class=\"token variable\"><span class=\"token variable\">`</span>rails credentials:edit<span class=\"token variable\">`</span></span></code></pre></div>\n<h2>Solution</h2>\n<p>There are two ways to put the master key to production server:</p>\n<ol>\n<li>Use of environment keys (<code class=\"language-text\">ENV[RAILS_MASTER_KEY]</code>)</li>\n<li>Copy <code class=\"language-text\">config/master.key</code> to your server manually without commiting to git</li>\n</ol>\n<p>Solution #1 didn’t work out well for capistrano in our case, thus we have used solution #2 for this app. Copying the file to production server that’s being managed by capistrano means I have to configure something so that I don’t copy the same key to server everytime we deploy the application. These are the steps to deploy the application successfully for the first time:</p>\n<ol>\n<li>Copy <code class=\"language-text\">config/master.key</code> from local filesystem to the production server under <code class=\"language-text\">&lt;project_root>/shared/config/master.key</code>.</li>\n<li>Configure capistrano’s <code class=\"language-text\">config/deploy.rb</code> to include this line:\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  set <span class=\"token symbol\">:linked_files</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">%w{config/master.key}</span></span></code></pre></div>\nBy doing this you’re telling Capistrano to symlink <code class=\"language-text\">config/master.key</code> to <code class=\"language-text\">&lt;project_root>/shared/config/master.key</code> which contains the master key you’ve just copied to the server.</li>\n<li>Deploy app again and verify that deployment is successful.</li>\n<li>Commit this confguration changes. Don’t check-in <code class=\"language-text\">config/master.key</code>!</li>\n</ol>\n<h2>Conclusion</h2>\n<p>This way of how credentials are managed might seem complicated at first glance, but thinking of how they are being managed locally without exposing it in the git repo, the way of copying master key to production and sharing master key to your colleagues seems to be easier compared to setting up environment variables remotely and informing the tech team when there’s any change on the credentials. It helps to secure the credentials by not exposing the credentials explicitly to each member of your team too.</p>\n<h2>References / External Links</h2>\n<ol>\n<li><a href=\"https://keithpblog.org/post/encrypted-secrets/\">https://keithpblog.org/post/encrypted-secrets/</a></li>\n<li><a href=\"https://www.engineyard.com/blog/rails-encrypted-credentials-on-rails-5.2\">https://www.engineyard.com/blog/rails-encrypted-credentials-on-rails-5.2</a></li>\n</ol>","frontmatter":{"title":"Deploying Rails 5.2 Applications with New Encrypted Credentials using Capistrano","date":"April 25, 2018","description":"","tags":["rails","capistrano","deployment","security"]}},"previous":{"fields":{"slug":"/2018-04-09---still-using-rake-for-commands-in-your-rails-5-projects/"},"frontmatter":{"title":"Still Using Rake for Commands in Your Rails 5 Projects?"}},"next":{"fields":{"slug":"/2018-04-26---react-fragment/"},"frontmatter":{"title":"Use of React.Fragment"}}},"pageContext":{"id":"5484272c-9c11-53ee-a053-0fd3664f2e60","previousPostId":"2f3e8921-825f-532f-b29f-ea7867abe009","nextPostId":"6a57db39-ade1-5901-9dbc-cf97206b5383"}},"staticQueryHashes":["2841359383","3257411868"]}